name: Deploy to EC2

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    name: Safe Deploy to EC2
    runs-on: ubuntu-latest
    environment: EC2_HOST

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Deploy via SSH with Safety
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Fail fast

            echo "üöÄ Starting Safe Deployment..."

            # Define directories
            APP_DIR=/home/${USER}/backend-drf
            TMP_DIR=/home/${USER}/backend-drf_tmp

            echo "üßπ Cleaning any old tmp clone..."
            rm -rf $TMP_DIR

            echo "üì• Cloning fresh code to temp directory..."
            git clone https://${{ secrets.GH_TOKEN }}@github.com/mbrsagor/backend-drf.git $TMP_DIR

            cd $TMP_DIR
            git checkout develop
            git pull origin develop

            echo "üî® Building Docker containers in temp dir..."
            docker-compose -f docker-compose.yml build --no-cache

            echo "‚úÖ Running tests & migrations in temp dir..."
            chmod +x script.sh
            ./script.sh || {
              echo "‚ùå script.sh failed. Canceling deployment."; 
              exit 1;
            }

            echo "üß¨ Stopping old app and swapping new version..."
            cd ~
            docker-compose -f $APP_DIR/docker-compose.yml down
            rm -rf $APP_DIR
            mv $TMP_DIR $APP_DIR

            echo "üöÄ Starting new version..."
            cd $APP_DIR
            docker-compose up -d

            echo "‚úÖ Deployment completed successfully and live app updated."
